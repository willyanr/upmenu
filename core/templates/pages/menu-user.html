{% extends 'index.html' %}

{% block content %}
<div class="w-full" id="alert-sucess" style="display: none;">
    <div id="toast-default" class="flex items-center w-full p-4 text-gray-500 bg-white rounded-lg shadow dark:text-gray-400 dark:bg-gray-800 mb-4" role="alert">
        <div class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 text-blue-500 bg-blue-100 rounded-lg dark:bg-[#79b330] dark:text-blue-200">
            <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 18 20">
                <path stroke="#ffffff" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.147 15.085a7.159 7.159 0 0 1-6.189 3.307A6.713 6.713 0 0 1 3.1 15.444c-2.679-4.513.287-8.737.888-9.548A4.373 4.373 0 0 0 5 1.608c1.287.953 6.445 3.218 5.537 10.5 1.5-1.122 2.706-3.01 2.853-6.14 1.433 1.049 3.993 5.395 1.757 9.117Z"/>
            </svg>
            <span class="sr-only">Fire icon</span>
        </div>
        <div class="ms-3 text-sm font-bold text-gray-300"> Pedido conclu√≠do com sucesso</div>
        <button type="button" class="ms-auto -mx-1.5 -my-1.5 bg-white text-gray-400 hover:text-gray-900 rounded-lg focus:ring-2 focus:ring-gray-300 p-1.5 hover:bg-gray-100 inline-flex items-center justify-center h-8 w-8 dark:text-gray-500 dark:hover:text-white dark:bg-gray-800 dark:hover:bg-gray-700" data-dismiss-target="#toast-default" aria-label="Close">
            <span class="sr-only">Close</span>
            <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
            </svg>
        </button>
    </div>
</div>
<p class="text-lg text-gray-300 ms-2 mb-2">Gar√ßon: <strong> {{ waiter.name}} </strong></p>
<div class="w-full border border-gray-800 rounded-xl p-2 mb-3">
    <p class="text-gray-300 text-sm ms-3 font-bold"> üèÜ MEUS PEDIDOS: <span class="bg-custom px-10 rounded-full text-lg text-white text-center ms-3">{{orders}}</span></p>
</div>
<div class="flex justify-between mb-3">
    <a href="" id="clear-button" type="button" class="inline-flex items-center px-8 py-1 text-sm font-medium text-center text-gray-400 rounded-xl dark:hover:bg-gray-700 focus:ring-4 focus:outline-none hover:text-white focus:ring-red-300 dark:hover:bg-gray-700 dark:focus:ring-red-800 border border-gray-800">
        Limpar 
    </a>
    <div class="fixed bottom-0 left-0 right-0 text-center z-50">
        <button id="open-modal-button" type="button" class="w-full px-5 py-3 text-sm font-medium text-white hover:bg-red-800 focus:ring-4 focus:outline-none focus:ring-blue-300 dark:hover:bg-gray-900 dark:focus:ring-red-800 border border-red-500 dark:bg-red-600 hover:text-white"> 
            <span class="px-3 py-1 text-lg font-medium leading-none rounded-full animate-pulse">Fazer Pedido</span>
        </button>
    </div>
    
</div>



<ul role="list" class="grid grid-cols-1 gap-2 sm:grid-cols-2 lg:grid-cols-4">
    {% for item in menu %}
    <li class="mb-3 relative">
        <input type="checkbox" id="item-checkbox-{{ item.id }}" data-item-id="{{ item.id }}" class="hidden peer item-checkbox" required="">
        <label for="item-checkbox-{{ item.id }}" class="inline-flex items-center justify-between w-full p-5 text-gray-500 bg-white border-2 border-gray-200 rounded-lg cursor-pointer dark:hover:text-gray-300 dark:border-gray-700 peer-checked:border-green-500 hover:text-gray-600 dark:peer-checked:text-gray-300 peer-checked:text-gray-600 hover:bg-gray-50 dark:text-gray-400 dark:bg-gray-800 dark:hover:bg-gray-700">
            <div class="block w-full">
                <div class="flex items-center">
                    <img class="mb-2 w-7 h-7 text-sky-500" src="{{ item.img.url }}" />
                    <div class="ml-3">
                        <div class="text-sm font-semibold text-white">{{ item.name }}</div>
                        <div class="text-sm w-full">{{ item.get_description }}</div>
                        <div class="mt-3 text-white font-bold">R$ {{ item.value }}</div>
                    </div>
                </div>
                <div class="absolute top-1/2 right-5 transform -translate-y-1/1 flex justify-center items-center w-8 h-8 bg-[#79B330] rounded-full">
                    <span class="text-white font-bold">+</span>
                </div>
            </div>
        </label>
    </li>
    
    {% endfor %}
</ul>
{% if results %}
<ul role="list" class="grid grid-cols-1 gap-2 sm:grid-cols-2 lg:grid-cols-4">
    {% for item in results %}
    <li class="mb-3 relative">
        <input type="checkbox" id="item-checkbox-{{ item.id }}" data-item-id="{{ item.id }}" class="hidden peer item-checkbox">
        <label for="item-checkbox-{{ item.id }}" class="inline-flex items-center justify-between w-full p-5 text-gray-500 bg-white border-2 border-gray-200 rounded-lg cursor-pointer dark:hover:text-gray-300 dark:border-gray-700 peer-checked:border-green-500 hover:text-gray-600 dark:peer-checked:text-gray-300 peer-checked:text-gray-600 hover:bg-gray-50 dark:text-gray-400 dark:bg-gray-800 dark:hover:bg-gray-700">
            <div class="block w-full">
                <div class="flex items-center">
                    <img class="mb-2 w-7 h-7 text-sky-500" src="{{ item.img.url }}" />
                    <div class="ml-3">
                        <div class="text-lg font-semibold text-white">{{ item.name }}</div>
                        <div class="text-sm w-40">{{ item.get_description }}</div>
                        <div class="mt-3 text-white font-bold">R$ {{ item.value }}</div>
                    </div>
                    
                </div>
                <div class="absolute top-1/2 right-5 transform -translate-y-1/2 flex justify-center items-center w-8 h-8 bg-[#79B330] rounded-full">
                    <span class="text-white font-bold">+</span>
                </div>
            </div>
        </label>
    </li>
    
    {% endfor %}
</ul>

    {% else %}

    {% endif %}
<div id="selected-items-modal" tabindex="-1" aria-hidden="true" class="hidden fixed inset-0 z-50 overflow-y-auto flex items-center justify-center bg-black bg-opacity-50 p-4">
    <div class="relative p-5 w-full max-w-lg bg-gray-800 rounded-lg shadow-lg">
        <button type="button" aria-label="Close" class="absolute top-3 right-3 text-gray-400 hover:bg-gray-700 hover:text-white rounded-lg text-sm w-8 h-8 inline-flex justify-center items-center">
            <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
            </svg>
            <span class="sr-only">Close modal</span>
        </button>
        <div class="p-4 max-h-[80vh] overflow-y-auto">
            <h1 class="dark:text-white uppercase">{{waiter.name}}</h1>
            <h3 class="mb-5 text-lg font-semibold text-gray-100">Itens Selecionados</h3>

            <ul id="selected-items-list" class="text-left mb-4">
                <!-- Itens selecionados ser√£o adicionados aqui -->
                 
            </ul>
  
            

            <div class="flex flex-col sm:flex-row sm:items-center sm:space-x-3">

                <label for="" class="text-sm text-gray-300 dark:text-white mb-1">Selecione a mesa:</label>
                <select id="table-select" class="w-full sm:w-40 bg-gray-700 border border-gray-600 text-gray-100 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 dark:bg-gray-900 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
                    {% for table in tables %}
                        <option value="{{ table.id }}">Mesa: {{ table.table_number }}</option>
                    {% endfor %}
                </select>
                
                <button type="button" class="z-50 mt-4 sm:mt-0 py-2.5 px-5 text-sm font-medium text-gray-900 bg-red-600 rounded-lg border border-gray-300 hover:bg-gray-200 hover:text-blue-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:bg-red-600 dark:text-white dark:border-gray-600 dark:hover:text-white dark:hover:bg-gray-700" onclick="submitOrder()">Enviar Pedido</button>
            </div>
        </div>
    </div>
</div>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        const selectedItemsList = document.getElementById('selected-items-list');
        const modal = document.getElementById('selected-items-modal');

        function openModal() {
            selectedItemsList.innerHTML = ''; // Limpa a lista de itens selecionados

            const checkboxes = document.querySelectorAll('.item-checkbox:checked');
            const fetchPromises = [];

            checkboxes.forEach(checkbox => {
                const itemId = checkbox.getAttribute('data-item-id');
                const itemLabel = checkbox.nextElementSibling;
                const itemName = itemLabel.querySelector('.text-sm').textContent;
                const itemPrice = itemLabel.querySelector('.text-white').textContent;
                const itemImg = itemLabel.querySelector('img').src;
                
                // Adiciona o item selecionado √† lista do modal
                selectedItemsList.innerHTML += `
                    <li class="mb-3">
                        <img class="w-16 h-16 mr-3" src="${itemImg}" alt="${itemName}">
                        <div class="font-semibold text-white">${itemName}</div>
                        <div class="text-gray-400">${itemPrice}</div>
                        <div id="ingredients-${itemId}" class="mt-2"></div>
                        <div class="mb-4 mt-2">
                            <label for="order-observation-${itemId}" class="block text-sm font-medium text-gray-100">Observa√ß√£o</label>
                            <textarea id="order-observation-${itemId}" rows="3" class="p-2 uppercase mt-1 block w-full rounded-md border-gray-600 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 sm:text-sm dark:bg-gray-900 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"></textarea>
                        </div>
                        <div class="mb-4 mt-2 w-20">
                            <label for="order-quantity-${itemId}" class="block text-sm font-medium text-gray-100">Quantidade</label>
                            <input type="number" id="order-quantity-${itemId}" min="1" value="1" class="mt-1 block w-full rounded-md border-gray-600 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 sm:text-sm dark:bg-gray-900 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
                        </div>
                    </li>
                `;


                // Fetch and add the ingredients for the item
                fetchPromises.push(fetch(`/menu/api/ingredients/${itemId}/`)
                    .then(response => response.json())
                    .then(data => {
                        const ingredientDiv = document.getElementById(`ingredients-${itemId}`);
                        ingredientDiv.innerHTML = '<h4 class="text-sm text-white font-medium mt-2">Remover ingredientes:</h4>';
                        data.ingredients.forEach(ingredient => {
                            ingredientDiv.innerHTML += `
                                <div class="flex items-center">
                                    <input type="checkbox" class="ingredient-checkbox" data-item-id="${itemId}" data-ingredient-id="${ingredient.id}" id="ingredient-${ingredient.id}">
                                    <label for="ingredient-${ingredient.id}" class="text-white ms-2">${ingredient.name}</label>
                                </div>
                            `;
                        });
                    }));
            });

            Promise.all(fetchPromises).then(() => {
                modal.classList.remove('hidden');
            });
        }

        // Fun√ß√£o para fechar o modal
        function closeModal() {
            modal.classList.add('hidden');
        }
    
        // Adiciona o listener ao bot√£o de fechar
        const closeButton = modal.querySelector('button[aria-label="Close"]');
        closeButton.addEventListener('click', closeModal);
    
        function submitOrder() {
            const selectedItems = Array.from(document.querySelectorAll('.item-checkbox:checked')).map(checkbox => {
                const itemId = checkbox.getAttribute('data-item-id');
                const quantityElement = document.getElementById(`order-quantity-${itemId}`);
                const observationElement = document.getElementById(`order-observation-${itemId}`);
                return {
                    id: itemId,
                    removed_ingredients: Array.from(document.querySelectorAll(`.ingredient-checkbox[data-item-id="${itemId}"]:checked`)).map(checkbox => checkbox.getAttribute('data-ingredient-id')),
                    quantity: quantityElement ? parseInt(quantityElement.value) : 1, 
                    observation: observationElement ? observationElement.value : ''
                };
            });

            const tableId = document.getElementById('table-select').value;
        
            if (selectedItems.length === 0) {
                alert('Please select at least one item.');
                return;
            }
        
            fetch('/restaurant/submit-order/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')  // Function to get CSRF token
                },
                body: JSON.stringify({
                    items: selectedItems,
                    tableId: tableId
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Success:', data);
                const alert = document.getElementById('alert-sucess');
                alert.style.display = 'block';
               
                setTimeout(() => {
                    alert.style.display = 'none';
                    window.location.reload();
                }, 2000);
                closeModal();
            })
            .catch((error) => {
                console.error('Error:', error);
            });
        }
        
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        document.getElementById('open-modal-button').addEventListener('click', openModal);

        // Exponha a fun√ß√£o para o escopo global
        window.submitOrder = submitOrder;
    });
</script>

{% endblock %}
